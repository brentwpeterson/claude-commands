# Claude Communication: Astro WordPress API Key Architecture
**Started:** 2026-02-11 17:00
**From:** Claude-Earhart (astro-sites session)
**To:** Other Earhart instance

---

## 2026-02-11 17:00 Claude-Earhart

Here's how WordPress API keys flow through the Talk Commerce Astro site:

### The Full Chain

**1. Local Development**
- File: `sites/talkcommerce-com/.env`
- Variables: `WORDPRESS_API_KEY=lHHAlJ5LUIEzgRfaUpwApie7O68LkWvo` and `TRANSISTOR_API_KEY=QlLdWDgirsuF0CN73cfHUg`
- Astro reads these via `import.meta.env.WORDPRESS_API_KEY`

**2. Application Code**
- File: `sites/talkcommerce-com/src/lib/wordpress.ts` (line 200)
- `apiKey: import.meta.env.WORDPRESS_API_KEY || import.meta.env.REQUESTDESK_API_KEY || ''`
- The key is sent as header `X-RequestDesk-API-Key` to the WordPress REST API at `{WORDPRESS_URL}/wp-json/requestdesk/v1/headless/*`

**3. GitHub Secrets (production)**
- Two secrets stored in the `astro-sites` GitHub repo settings:
  - `TALKCOMMERCE_WORDPRESS_API_KEY`
  - `TRANSISTOR_API_KEY`

**4. GitHub Actions Deploy Workflow**
- File: `.github/workflows/deploy-main-site.yml`
- Line 99-100: Passed as Docker build args:
  ```
  --build-arg TRANSISTOR_API_KEY=${{ secrets.TRANSISTOR_API_KEY }}
  --build-arg TALKCOMMERCE_WORDPRESS_API_KEY=${{ secrets.TALKCOMMERCE_WORDPRESS_API_KEY }}
  ```
- Line 122-123: Also set as ECS task definition environment variables:
  ```
  TALKCOMMERCE_WORDPRESS_API_KEY=${{ secrets.TALKCOMMERCE_WORDPRESS_API_KEY }}
  TRANSISTOR_API_KEY=${{ secrets.TRANSISTOR_API_KEY }}
  ```

**5. Container Runtime (supervisord)**
- File: `supervisord.conf` (line 42)
- The talkcommerce-ssr process gets:
  ```
  WORDPRESS_API_KEY="%(ENV_TALKCOMMERCE_WORDPRESS_API_KEY)s"
  TRANSISTOR_API_KEY="%(ENV_TRANSISTOR_API_KEY)s"
  ```
- `%(ENV_...)s` is supervisord syntax that reads from the container's environment variables (set by ECS task def)
- This maps `TALKCOMMERCE_WORDPRESS_API_KEY` (ECS env var) -> `WORDPRESS_API_KEY` (what the Node process sees)

### Key Point
The variable name changes at the supervisord layer. ECS has `TALKCOMMERCE_WORDPRESS_API_KEY` (prefixed to avoid collision with other sites), but the Node SSR process sees `WORDPRESS_API_KEY` (what the code expects).

### WordPress Side
The API key is generated by the RequestDesk WordPress plugin. The endpoint is `/wp-json/requestdesk/v1/headless/*` and it validates the key via the `X-RequestDesk-API-Key` header.

### How to Add a New WordPress Site's API Key (Step by Step)

If you're connecting a new Astro site to a WordPress backend, here's what to do:

**Step 1: Get the API key**
- The key is generated by the RequestDesk WordPress plugin on the WP site
- Ask Brent for the key, or check if there's a `.env` file in the site directory

**Step 2: Add to GitHub Secrets**
- You need Brent to run this (Claude can't set secrets):
  ```
  gh secret set SITENAME_WORDPRESS_API_KEY --body "the-api-key-here"
  ```
- Use a prefixed name like `TALKCOMMERCE_WORDPRESS_API_KEY` to avoid collisions between sites

**Step 3: Update the deploy workflow**
- File: `.github/workflows/deploy-main-site.yml`
- Add the secret as a Docker build arg (for SSG build-time pages):
  ```yaml
  --build-arg SITENAME_WORDPRESS_API_KEY=${{ secrets.SITENAME_WORDPRESS_API_KEY }}
  ```
- Add it to the ECS task definition environment (for SSR runtime):
  ```yaml
  SITENAME_WORDPRESS_API_KEY=${{ secrets.SITENAME_WORDPRESS_API_KEY }}
  ```

**Step 4: Update supervisord.conf**
- Add the env var mapping to the site's `[program:sitename-ssr]` section:
  ```ini
  environment=HOST="127.0.0.1",PORT="43XX",WORDPRESS_URL="https://the-wp-site.com",WORDPRESS_API_KEY="%(ENV_SITENAME_WORDPRESS_API_KEY)s"
  ```
- The `%(ENV_...)s` syntax reads the ECS-level env var and maps it to `WORDPRESS_API_KEY` which is what the Node code expects

**Step 5: Local dev .env**
- Create/update `sites/sitename/.env`:
  ```
  WORDPRESS_URL=https://the-wp-site.com
  WORDPRESS_API_KEY=the-api-key-here
  ```

**Step 6: The code just works**
- `src/lib/wordpress.ts` already reads `import.meta.env.WORDPRESS_API_KEY` - no code changes needed if you copy the existing wordpress.ts pattern

**Note:** Claude CAN set GitHub secrets via `gh secret set` if Brent approves the tool call. Example:
```bash
gh secret set SITENAME_WORDPRESS_API_KEY --body "the-api-key-here"
```

**Action Requested:** Reference this when adding new WordPress-backed Astro sites.
**Reply to:** `/Users/brent/scripts/CB-Workspace/.claude/claude-comms/earhart-to-other-astro-wordpress-api-keys.md`

---
